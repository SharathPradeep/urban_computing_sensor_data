<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sensor Logger (GPS + Microphone)</title>
<body style="font:16px -apple-system,system-ui; padding:16px; line-height:1.35">
<h2>Sensor Logger (GPS + Microphone)</h2>

<div id="status">Stopped</div>
<br>
<button id="start">Start</button>
<button id="stop" disabled>Stop</button>
<button id="download" disabled>Download Sensor Log</button>

<hr>

<div id="micDisplay">Mic: -- dBFS</div>
<div id="locationDisplay">Location: -- , --</div>

<script>
(() => {
  const $ = id => document.getElementById(id);
  const statusEl = $('status'), micEl = $('micDisplay'), locEl = $('locationDisplay');
  const startBtn = $('start'), stopBtn = $('stop'), dlBtn = $('download');

  let stream, ctx, ana, src, raf, gpsId = null, logging = false, lastDB = NaN;
  const buf = new Float32Array(2048);
  const csv = ['sep=,','timestamp,lat,lon,accuracy_m,speed_mps,sound_dbfs'];

  const fmt = (n, d) => Number.isFinite(n) ? Number(n).toFixed(d) : '';
  const dbfs = rms => 20 * Math.log10(Math.max(rms, 1e-12));

  function sampleDB() {
    ana.getFloatTimeDomainData(buf);
    let s = 0; for (let i = 0; i < buf.length; i++) s += buf[i] * buf[i];
    lastDB = dbfs(Math.sqrt(s / buf.length));
    micEl.textContent = `Mic: ${lastDB.toFixed(1)} dBFS`;
    if (logging) raf = requestAnimationFrame(sampleDB);
  }

  function onPos(p) {
    const { latitude: lat, longitude: lon, accuracy: acc, speed: spd } = p.coords;
    locEl.textContent = `Location: ${fmt(lat,6)}, ${fmt(lon,6)} (Â±${fmt(acc,1)}m)`;
    csv.push([
      new Date().toISOString(),
      fmt(lat,6), fmt(lon,6), fmt(acc,1),
      Number.isFinite(spd) ? fmt(spd,2) : '',
      Number.isFinite(lastDB) ? fmt(lastDB,2) : ''
    ].join(','));
  }

  function onGeoErr(e){ locEl.textContent = `Location: Error - ${e.message}`; }

  function startGPS() {
    const opts = { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 };
    navigator.geolocation.getCurrentPosition(onPos, onGeoErr, opts);
    gpsId = setInterval(() => navigator.geolocation.getCurrentPosition(onPos, onGeoErr, opts), 250);
  }

  async function start() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      ctx = new (window.AudioContext || window.webkitAudioContext)();
      ana = ctx.createAnalyser(); ana.fftSize = 2048;
      src = ctx.createMediaStreamSource(stream); src.connect(ana);
      if (!('geolocation' in navigator)) throw new Error('Geolocation not available');
      startGPS();
      logging = true; sampleDB();
      statusEl.textContent = 'Running...';
      startBtn.disabled = true; stopBtn.disabled = false; dlBtn.disabled = false;
    } catch (e) { statusEl.textContent = 'Error: ' + e.message; console.error(e); }
  }

  function stop() {
    logging = false;
    if (raf) cancelAnimationFrame(raf);
    if (gpsId != null) { clearInterval(gpsId); gpsId = null; }
    try { src && src.disconnect(); } catch {}
    try { ctx && ctx.close(); } catch {}
    try { stream && stream.getTracks().forEach(t => t.stop()); } catch {}
    statusEl.textContent = 'Stopped';
    startBtn.disabled = false; stopBtn.disabled = true;
  }

  function download() {
    const bom = new Uint8Array([0xEF,0xBB,0xBF]);
    const blob = new Blob([bom, csv.join('\n') + '\n'], { type: 'text/csv;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `sensor_log_${new Date().toISOString().replace(/[:.]/g,'-')}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  startBtn.addEventListener('click', start, { passive:true });
  stopBtn.addEventListener('click', stop, { passive:true });
  dlBtn.addEventListener('click', download, { passive:true });
})();
</script>
</body>
</html>